#!/usr/bin/env bash
set -euo pipefail

dir="${1:-$PWD}"
dir="$(realpath "$dir")"
name="$(basename "$dir")"

if ! tmux has-session -t "$name" 2>/dev/null; then
  tmux new-session -d -s "$name" -c "$dir" -n cli
  tmux new-window -t "$name" -c "$dir" -n claude
  tmux send-keys -t "$name:claude" "ai-sandbox.sh '$dir' claude" Enter
  tmux new-window -t "$name" -c "$dir" -n code
  tmux send-keys -t "$name:code" "nvim" Enter
  tmux select-window -t "$name:code"
fi

# Find a detached linked view to reuse, or create a new one
view=""
for s in $(tmux list-sessions -F '#{session_name}:#{session_attached}' 2>/dev/null); do
  s_name="${s%:*}"
  s_attached="${s##*:}"
  if [[ "$s_name" == "$name" || "$s_name" == "$name"-* ]] && [[ "$s_attached" == "0" ]]; then
    view="$s_name"
    break
  fi
done

if [ -z "$view" ]; then
  n=0
  view="$name"
  while tmux has-session -t "$view" 2>/dev/null; do
    n=$((n + 1))
    view="${name}-${n}"
  done
  tmux new-session -d -s "$view" -t "$name"
fi

if [ -n "${TMUX:-}" ]; then
  tmux switch-client -t "$view:code"
else
  tmux attach -t "$view:code"
fi
